library(MSnbase)
library(MSqRob)
options(stringsAsFactors=T)
peptides <- read2MSnSet("q_input.txt",pattern="Intensity_")
#head(exprs(peptides))
exp_annotation <- read.csv("exp_design.txt",sep="\t")
exp_annotation$genotype <- make.names(exp_annotation$exp_condition)
exp_annotation$run <- paste0("Intensity_",exp_annotation$raw_file)
for (c in 1:ncol(exp_annotation)) {
  exp_annotation[,c] <- as.factor(exp_annotation[,c])
}

## Running MSqRob
# Had to change normalization due to error in preprocesscore
peptides <- preprocess_MSnSet(peptides,accession="Protein.Groups",split=",", useful_properties="Sequence", exp_annotation=exp_annotation, normalisation="center.median")

# necessary due to change to R 4.x    
fData(peptides)[,"Protein.Groups"] <- as.factor(fData(peptides)[,"Protein.Groups"])
# Set data.frame for experimental design with columns run genotype biorep
proteins <- MSnSet2protdata(peptides, accession="Protein.Groups")  
#head(proteins)
system.time(protLM <- fit.model(proteins, response="quant_value", fixed=c("genotype"),  random=c("biorep","run","Sequence"), add.intercept=TRUE))
#create comparisons vs first
contrasts <- NULL
levels <- as.factor(paste0("genotype",make.names(unique(exp_annotation$genotype))))
# levels <- unique(exp_annotation$genotype)
if (length(levels) > 1) {
  for (i in levels[-1]) {
    contrasts <- append(contrasts, paste(i, levels[1], sep="-"))  
  }
} else {
  contrasts <- levels
}
L <- makeContrast(contrasts=contrasts,levels=as.character(levels))
result <- test.protLMcontrast(protLM, L)
result <- prot.p.adjust(result, method="fdr")
write.csv(result, "MSqRobOut.csv")
result <- as.data.frame(result)

## Merging more data from peptide and protein level
all_peptides <- list()
protnames <- NULL
for (type in exp_annotation$raw_file) {
  tin <- read.csv(paste0(type,"_peptides.txt"), sep="\t")
  protnames <- tin[, c("Modified.Sequence","Protein.s.")]
  tin <- tin[,c( "Modified.Sequence","X.Validated.PSMs")]
  colnames(tin) <- paste0(c("modified_peptide", "number_psms"), "_", type)
  all_peptides[[type]] <- tin
}
protnames <- unique(protnames)
rownames(protnames) <- protnames[,1]
all_pep <- Reduce(function(x, y) merge(x, y, by=1, all=TRUE), all_peptides)

rownames(all_pep) <- all_pep[,1]
# merging with quant data
stand_pep_quant <- cbind(all_pep[fData(peptides)$Sequence,], protnames[fData(peptides)$Sequence, 2], exprs(peptides))
for (r in 1:nrow(exp_annotation)) {
  colnames(stand_pep_quant) <- sub(paste0("Intensity_", exp_annotation$raw_file[r]), paste0("abundance_", exp_annotation$exp_condition[r], "_",
                                                                                             exp_annotation$biorep[r]), colnames(stand_pep_quant))
}
write.csv(stand_pep_quant, "stand_pep_quant_merged.csv", row.names=F)


# Merging data from peptideshaker, flashlfq and msqrob
quant_prots <- read.csv("q_prot.txt", sep="\t")
rownames(quant_prots) <- quant_prots[, "Protein.Groups"]
quant_prots <- quant_prots[, grep("^Intensity",colnames(quant_prots))]
all_proteins <- list()
for (type in exp_annotation$raw_file) {
  tin <- read.csv(paste0(type,"_proteins.txt"), sep="\t")
  tin <- tin[,c("Protein.Group", "X.Unique.Peptides")]
  colnames(tin) <- c("protein_group", paste0("number_of_peptides_", type))
  all_proteins[[type]] <- tin
}
all_prot <- Reduce(function(x, y) merge(x, y, by=1, all=TRUE), all_proteins)
# merging with quant data
rownames(all_prot) <- all_prot[,1]
stand_prot_quant <- cbind(all_prot[rownames(result),], log2(quant_prots[rownames(result), ]), result[,grep("estimate$|qval$", colnames(result))])
# Exchanging file name based columns names to the ones defined in the experimental design
for (r in 1:nrow(exp_annotation)) {
  colnames(stand_prot_quant) <- sub(paste0("Intensity_", exp_annotation$raw_file[r]), paste0("abundance_", exp_annotation$exp_condition[r], "_",
                                                                                             exp_annotation$biorep[r]), colnames(stand_prot_quant))
}

ttt <- colnames(stand_prot_quant)[grep("estimate$", colnames(stand_prot_quant))] 
ttt <- sub("estimate$", "", ttt)
colnames(stand_prot_quant)[grep("estimate$", colnames(stand_prot_quant))] <- paste0("log_fold_change_", ttt)
ttt <- colnames(stand_prot_quant)[grep("qval$", colnames(stand_prot_quant))] 
ttt <- sub("qval$", "", ttt)
colnames(stand_prot_quant)[grep("qval$", colnames(stand_prot_quant))] <- paste0("differential_regulation_", ttt)
write.csv(stand_prot_quant, "stand_prot_quant_merged.csv", row.names=F)



